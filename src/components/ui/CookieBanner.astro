---
/**
 * Cookie Banner Component
 * GDPR-compliant cookie consent modal with category toggles
 * - Shows on first visit (no consent stored)
 * - Can be reopened from footer link (data-cookie-settings)
 * - Stores consent in localStorage
 * - Dispatches 'cookie-consent' event for analytics integration
 */

interface CookieCategory {
  id: string;
  name: string;
  description: string;
  required?: boolean;
}

interface Props {
  categories?: CookieCategory[];
}

const defaultCategories: CookieCategory[] = [
  {
    id: 'necessary',
    name: 'Notwendig',
    description: 'Diese Cookies sind für die Grundfunktionen der Website erforderlich und können nicht deaktiviert werden.',
    required: true,
  },
  {
    id: 'statistics',
    name: 'Statistik',
    description: 'Helfen uns zu verstehen, wie Besucher mit der Website interagieren, um die Nutzererfahrung zu verbessern.',
  },
  {
    id: 'marketing',
    name: 'Marketing',
    description: 'Werden verwendet, um Besuchern relevante Werbung und personalisierte Inhalte anzuzeigen.',
  },
];

const { categories = defaultCategories } = Astro.props;
---

<!-- Cookie Banner Backdrop -->
<div
  id="cookie-banner"
  class="cookie-banner"
  role="dialog"
  aria-modal="true"
  aria-labelledby="cookie-banner-title"
  data-cookie-banner
>
  <!-- Modal -->
  <div class="cookie-banner__modal">
    <!-- Header -->
    <div class="cookie-banner__header">
      <h2 id="cookie-banner-title" class="cookie-banner__title">
        Cookie-Einstellungen
      </h2>
      <button
        type="button"
        class="cookie-banner__close"
        aria-label="Schliessen"
        data-cookie-close
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <!-- Content -->
    <div class="cookie-banner__content">
      <p class="cookie-banner__description">
        Wir verwenden Cookies, um Ihnen die bestmögliche Erfahrung auf unserer
        Website zu bieten. Sie können Ihre Einstellungen jederzeit anpassen.
      </p>

      <!-- Categories -->
      <div class="cookie-banner__categories">
        {categories.map((category) => (
          <div class="cookie-banner__category">
            <div class="cookie-banner__category-info">
              <h3 class="cookie-banner__category-name">{category.name}</h3>
              <p class="cookie-banner__category-desc">{category.description}</p>
            </div>

            {category.required ? (
              <span class="cookie-banner__always-on">Immer aktiv</span>
            ) : (
              <label class="cookie-banner__toggle">
                <input
                  type="checkbox"
                  name={`cookie-${category.id}`}
                  class="cookie-banner__checkbox"
                />
                <span class="cookie-banner__toggle-track">
                  <span class="cookie-banner__toggle-thumb"></span>
                </span>
                <span class="sr-only">{category.name} aktivieren</span>
              </label>
            )}
          </div>
        ))}
      </div>
    </div>

    <!-- Footer -->
    <div class="cookie-banner__footer">
      <div class="cookie-banner__actions">
        <button
          type="button"
          class="cookie-banner__btn cookie-banner__btn--primary"
          data-cookie-accept-all
        >
          Alle akzeptieren
        </button>
        <button
          type="button"
          class="cookie-banner__btn cookie-banner__btn--secondary"
          data-cookie-save
        >
          Auswahl speichern
        </button>
      </div>

      <div class="cookie-banner__legal">
        <a href="/datenschutz-impressum">Datenschutz</a>
        <span class="cookie-banner__legal-sep">&bull;</span>
        <a href="/datenschutz-impressum#impressum">Impressum</a>
      </div>
    </div>
  </div>
</div>

<style>
  /* ═══════════════════════════════════════════════════════════════
     COOKIE BANNER
     ═══════════════════════════════════════════════════════════════ */
  .cookie-banner {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .cookie-banner--visible {
    opacity: 1;
    visibility: visible;
  }

  /* ═══════════════════════════════════════════════════════════════
     MODAL
     ═══════════════════════════════════════════════════════════════ */
  .cookie-banner__modal {
    background: white;
    border-radius: 1.5rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    max-width: 32rem;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(20px);
    transition: transform 0.3s ease;
  }

  .cookie-banner--visible .cookie-banner__modal {
    transform: translateY(0);
  }

  /* ═══════════════════════════════════════════════════════════════
     HEADER
     ═══════════════════════════════════════════════════════════════ */
  .cookie-banner__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    border-bottom: 1px solid var(--color-neutral-200, #e8e2db);
  }

  .cookie-banner__title {
    font-family: var(--font-heading, 'Abril Fatface', serif);
    font-size: 1.5rem;
    font-weight: 400;
    color: var(--color-primary, #255a4e);
    margin: 0;
  }

  .cookie-banner__close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    background: none;
    border: none;
    border-radius: 50%;
    color: var(--color-neutral-500, #9a8b7c);
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .cookie-banner__close:hover {
    background-color: var(--color-neutral-100, #f5f0eb);
    color: var(--color-neutral-800, #423a35);
  }

  .cookie-banner__close .material-symbols-outlined {
    font-size: 1.5rem;
  }

  /* ═══════════════════════════════════════════════════════════════
     CONTENT
     ═══════════════════════════════════════════════════════════════ */
  .cookie-banner__content {
    padding: 1.5rem;
  }

  .cookie-banner__description {
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--color-neutral-700, #5f524a);
    margin: 0 0 1.5rem 0;
  }

  /* ═══════════════════════════════════════════════════════════════
     CATEGORIES
     ═══════════════════════════════════════════════════════════════ */
  .cookie-banner__categories {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .cookie-banner__category {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    padding: 1rem;
    background-color: var(--color-neutral-50, #f8f7f4);
    border-radius: 0.75rem;
  }

  .cookie-banner__category-info {
    flex: 1;
    min-width: 0;
  }

  .cookie-banner__category-name {
    font-family: var(--font-sans, 'Heebo', sans-serif);
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-neutral-900, #141110);
    margin: 0 0 0.25rem 0;
  }

  .cookie-banner__category-desc {
    font-size: 0.8125rem;
    line-height: 1.5;
    color: var(--color-neutral-600, #7d6d5e);
    margin: 0;
  }

  .cookie-banner__always-on {
    flex-shrink: 0;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-primary, #255a4e);
    white-space: nowrap;
  }

  /* ═══════════════════════════════════════════════════════════════
     TOGGLE SWITCH
     ═══════════════════════════════════════════════════════════════ */
  .cookie-banner__toggle {
    position: relative;
    flex-shrink: 0;
    cursor: pointer;
  }

  .cookie-banner__checkbox {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .cookie-banner__toggle-track {
    display: block;
    width: 2.75rem;
    height: 1.5rem;
    background-color: var(--color-neutral-300, #d6cdc3);
    border-radius: 1rem;
    transition: background-color 0.2s ease;
  }

  .cookie-banner__checkbox:checked + .cookie-banner__toggle-track {
    background-color: var(--color-primary, #255a4e);
  }

  .cookie-banner__checkbox:focus-visible + .cookie-banner__toggle-track {
    outline: 2px solid var(--color-primary, #255a4e);
    outline-offset: 2px;
  }

  .cookie-banner__toggle-thumb {
    display: block;
    width: 1.25rem;
    height: 1.25rem;
    background-color: white;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    position: absolute;
    top: 0.125rem;
    left: 0.125rem;
    transition: transform 0.2s ease;
  }

  .cookie-banner__checkbox:checked ~ .cookie-banner__toggle-track .cookie-banner__toggle-thumb {
    transform: translateX(1.25rem);
  }

  /* ═══════════════════════════════════════════════════════════════
     FOOTER
     ═══════════════════════════════════════════════════════════════ */
  .cookie-banner__footer {
    padding: 1.5rem;
    border-top: 1px solid var(--color-neutral-200, #e8e2db);
  }

  .cookie-banner__actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  @media (min-width: 480px) {
    .cookie-banner__actions {
      flex-direction: row;
    }
  }

  .cookie-banner__btn {
    flex: 1;
    padding: 0.875rem 1.5rem;
    font-family: var(--font-sans, 'Heebo', sans-serif);
    font-size: 0.9375rem;
    font-weight: 600;
    border-radius: 3rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
  }

  .cookie-banner__btn--primary {
    background-color: var(--color-accent, #ff6b30);
    color: white;
  }

  .cookie-banner__btn--primary:hover {
    background-color: var(--color-accent-600, #e55a20);
  }

  .cookie-banner__btn--secondary {
    background-color: var(--color-neutral-100, #f5f0eb);
    color: var(--color-neutral-800, #423a35);
  }

  .cookie-banner__btn--secondary:hover {
    background-color: var(--color-neutral-200, #e8e2db);
  }

  .cookie-banner__legal {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
    font-size: 0.8125rem;
  }

  .cookie-banner__legal a {
    color: var(--color-neutral-500, #9a8b7c);
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s ease;
  }

  .cookie-banner__legal a:hover {
    color: var(--color-neutral-800, #423a35);
  }

  .cookie-banner__legal-sep {
    color: var(--color-neutral-400, #b8aca0);
  }

  /* Screen reader only */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>

<script>
  // Cookie Banner Controller
  const banner = document.querySelector('[data-cookie-banner]') as HTMLElement | null;
  const closeBtn = document.querySelector('[data-cookie-close]');
  const acceptAllBtn = document.querySelector('[data-cookie-accept-all]');
  const saveBtn = document.querySelector('[data-cookie-save]');

  const STORAGE_KEY = 'noevu-cookie-consent';

  function showBanner() {
    banner?.classList.add('cookie-banner--visible');
    document.body.style.overflow = 'hidden';
    // Focus trap - focus first focusable element
    const firstFocusable = banner?.querySelector('button, input') as HTMLElement | null;
    firstFocusable?.focus();
  }

  function hideBanner() {
    banner?.classList.remove('cookie-banner--visible');
    document.body.style.overflow = '';
  }

  function getConsent(): Record<string, boolean> | null {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : null;
    } catch {
      return null;
    }
  }

  function saveConsent(acceptAll = false) {
    const consent: Record<string, boolean> = { necessary: true };

    if (acceptAll) {
      consent.statistics = true;
      consent.marketing = true;
    } else {
      // Get values from checkboxes
      document.querySelectorAll<HTMLInputElement>('[name^="cookie-"]').forEach((input) => {
        const key = input.name.replace('cookie-', '');
        consent[key] = input.checked;
      });
    }

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(consent));
    } catch {
      // localStorage might be unavailable
    }

    hideBanner();

    // Dispatch event for analytics integration
    window.dispatchEvent(new CustomEvent('cookie-consent', { detail: consent }));

    // Load analytics if statistics consent given
    if (consent.statistics) {
      loadAnalytics();
    }
  }

  function loadAnalytics() {
    // Placeholder for analytics initialization
    // Example: Google Analytics
    // gtag('consent', 'update', { analytics_storage: 'granted' });
  }

  function restoreState() {
    const consent = getConsent();
    if (consent) {
      // Restore checkbox states
      Object.entries(consent).forEach(([key, value]) => {
        const checkbox = document.querySelector<HTMLInputElement>(`[name="cookie-${key}"]`);
        if (checkbox) {
          checkbox.checked = value;
        }
      });
    }
  }

  // Check if consent exists on page load
  if (!getConsent()) {
    // Show banner after a short delay for better UX
    setTimeout(showBanner, 1000);
  } else {
    // Restore state and apply consent
    restoreState();
    const consent = getConsent();
    if (consent?.statistics) {
      loadAnalytics();
    }
  }

  // Event listeners
  closeBtn?.addEventListener('click', () => {
    // Close without saving - will show again on next visit
    hideBanner();
  });

  acceptAllBtn?.addEventListener('click', () => {
    saveConsent(true);
  });

  saveBtn?.addEventListener('click', () => {
    saveConsent(false);
  });

  // Escape key to close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && banner?.classList.contains('cookie-banner--visible')) {
      hideBanner();
    }
  });

  // Click outside modal to close
  banner?.addEventListener('click', (e) => {
    if (e.target === banner) {
      hideBanner();
    }
  });

  // Reopen from footer link or any element with data-cookie-settings
  document.querySelectorAll('[data-cookie-settings]').forEach((trigger) => {
    trigger.addEventListener('click', (e) => {
      e.preventDefault();
      restoreState();
      showBanner();
    });
  });
</script>
