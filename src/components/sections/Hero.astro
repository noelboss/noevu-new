---
import type { HeroSection, Theme } from '../../schemas/sections';
import { parseInlineMarkdown } from '../../utils/markdown';

interface Props {
  data: HeroSection;
  theme?: Theme;
}

const { data, theme } = Astro.props;
const {
  headline,
  subheadline,
  description,
  image,
  backgroundImage,
  ctas,
  rating,
  alignment = 'left',
} = data;

const alignmentClass = `hero--${alignment}`;
const parsedHeadline = parseInlineMarkdown(headline);

// Avatar images for social proof
const avatars = [
  '/images/avatars/p1.png',
  '/images/avatars/p2.png',
  '/images/avatars/p3.png',
];
---

<section class={`hero ${alignmentClass}`} data-theme={theme}>
  {backgroundImage && (
    <div class="hero__background">
      <img
        src={backgroundImage.src}
        alt={backgroundImage.alt}
        loading="eager"
        class="hero__background-image"
      />
    </div>
  )}

  <div class="hero__container container">
    <div class="hero__content">
      {subheadline && (
        <h1 class="hero__subheadline">
          {subheadline}
          <span class="hero__subheadline-dot"></span>
        </h1>
      )}

      <h2 class="hero__headline" set:html={parsedHeadline} />

      {description && <div class="hero__description" set:html={description} />}

      {ctas && ctas.length > 0 && (
        <div class="hero__ctas">
          {ctas.map((cta, index) => (
            index === 0 ? (
              <a
                href={cta.href}
                class="hero__cta-primary"
                target={cta.external ? '_blank' : undefined}
                rel={cta.external ? 'noopener noreferrer' : undefined}
              >
                <span class="hero__cta-text">{cta.label}</span>
                <span class="hero__cta-icon">
                  <span class="material-symbols-outlined">calendar_month</span>
                </span>
              </a>
            ) : (
              <a
                href={cta.href}
                class="hero__cta-secondary"
                target={cta.external ? '_blank' : undefined}
                rel={cta.external ? 'noopener noreferrer' : undefined}
              >
                {cta.label}
                <span class="material-symbols-outlined">arrow_forward</span>
              </a>
            )
          ))}
        </div>
      )}

      {rating && (
        <div class="hero__social-proof">
          <div class="hero__avatars">
            {avatars.map((avatar, i) => (
              <div class="hero__avatar" style={`--index: ${i}`}>
                <img src={avatar} alt="" loading="lazy" />
              </div>
            ))}
          </div>
          <div class="hero__proof-text">
            <span class="hero__proof-label">KMU vertrauen unserer Webagentur</span>
            <span class="hero__proof-rating">
              <span class="hero__stars">
                {Array.from({ length: 5 }).map((_, i) => (
                  <span class="material-symbols-outlined hero__star" data-filled={i < Math.floor(rating.score)}>star</span>
                ))}
              </span>
              {rating.score} Sterne {rating.label || 'Bewertungen'} auf Google
            </span>
          </div>
        </div>
      )}
    </div>

    {image && (
      <div class="hero__image">
        <img
          src={image.src}
          alt={image.alt}
          width={image.width}
          height={image.height}
          loading="eager"
        />
      </div>
    )}
  </div>
</section>

<style>
  .hero {
    position: relative;
    /* Account for fixed header: topbar (2.5rem) + main nav (4rem) + section padding */
    padding-block: calc(var(--header-height, 6.5rem) + 2rem) 5rem;
    overflow: hidden;
    background-color: var(--theme-bg, var(--color-bg-beige));
    color: var(--theme-text, var(--color-text));
    min-height: 70vh;
    display: flex;
    align-items: center;
  }

  /* ═══════════════════════════════════════════════════════════════
     BACKGROUND
     ═══════════════════════════════════════════════════════════════ */
  .hero__background {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  .hero__background-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: right center;
  }

  /* ═══════════════════════════════════════════════════════════════
     CONTAINER
     ═══════════════════════════════════════════════════════════════ */
  .hero__container {
    position: relative;
    z-index: 1;
    display: grid;
    gap: 3rem;
    align-items: center;
    width: 100%;
  }

  @media (min-width: 1024px) {
    .hero__container {
      grid-template-columns: 1fr 1fr;
    }
  }

  .hero__content {
    max-width: 600px;
  }

  .hero--center {
    text-align: center;
  }

  .hero--center .hero__content {
    margin-inline: auto;
    max-width: 800px;
  }

  .hero--center .hero__ctas {
    justify-content: center;
  }

  .hero--center .hero__social-proof {
    justify-content: center;
  }

  /* ═══════════════════════════════════════════════════════════════
     SUBHEADLINE (h1 - SEO title, styled small)
     Matches live site: 14px Heebo, muted primary color
     ═══════════════════════════════════════════════════════════════ */
  .hero__subheadline {
    display: inline-flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.375rem;
    font-family: var(--font-sans, 'Heebo', sans-serif);
    font-size: 0.875rem; /* 14px */
    font-weight: 400;
    color: hsla(var(--color-primary-hsl, 163, 46%, 26%), 0.75);
    margin-bottom: 1rem;
    line-height: 1.5;
    /* Tag-style glass effect */
    backdrop-filter: blur(10px);
    background-color: hsla(163, 46%, 26%, 0.1);
    padding: 4px 12px;
    border-radius: 100px;
    transition: background-color 0.25s ease-in-out;
  }

  .hero__subheadline:hover {
    background-color: hsla(163, 46%, 26%, 0.2);
  }

  .hero__subheadline-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    background: hsla(17, 100%, 59%, 0.8);
    border-radius: 50%;
    box-shadow: 0 0 5px hsla(17, 100%, 59%, 0.6);
    flex-shrink: 0;
    transition: all 0.2s ease-in-out;
  }

  .hero__subheadline:hover .hero__subheadline-dot {
    background: hsla(17, 100%, 59%, 1);
    box-shadow: 0 0 8px hsla(17, 100%, 59%, 1);
  }

  /* ═══════════════════════════════════════════════════════════════
     HEADLINE
     ═══════════════════════════════════════════════════════════════ */
  .hero__headline {
    font-size: clamp(2.5rem, 5vw, 3.5rem);
    font-family: var(--font-display, 'Abril Fatface', serif);
    font-weight: 400;
    line-height: 1.15;
    margin-bottom: 1.5rem;
    /* Gradient text effect - light theme default */
    background: linear-gradient(330deg, var(--color-primary, #255a4e) 20%, var(--color-neutral-700, #5f524a) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* Emphasized text in headline - orange highlight underline
     Dual background: text gradient + highlight gradient at bottom
     Highlight animates in when element enters viewport */
  .hero__headline :global(strong),
  .hero__headline :global(em) {
    font-style: normal;
    font-weight: inherit; /* Abril Fatface only has one weight */
    /* Dual background: text gradient + orange highlight that fades right */
    background:
      linear-gradient(330deg, var(--color-primary, #255a4e) 20%, var(--color-neutral-700, #5f524a) 100%),
      linear-gradient(to right, var(--color-orange, #ff6b30) 0%, transparent 100%);
    background-size: 100% 100%, 0% 0.35em; /* Highlight starts at 0% width */
    background-position: 0 0, 0 calc(100% - 0.15em);
    background-repeat: no-repeat;
    -webkit-background-clip: text, padding-box;
    background-clip: text, padding-box;
    -webkit-text-fill-color: transparent;
    padding-bottom: 0.1em;
    transition: background-size 0.8s cubic-bezier(0.19, 1, 0.22, 1);
  }

  /* Animate highlight when hero is visible */
  .hero.is-visible .hero__headline :global(strong),
  .hero.is-visible .hero__headline :global(em) {
    background-size: 100% 100%, 100% 0.35em; /* Highlight grows to full width */
  }

  /* ═══════════════════════════════════════════════════════════════
     DESCRIPTION
     ═══════════════════════════════════════════════════════════════ */
  .hero__description {
    font-size: 1rem;
    color: var(--theme-text, var(--color-text));
    line-height: 1.7;
    margin-bottom: 2rem;
  }

  .hero__description :global(a) {
    color: var(--color-green, #255a4e);
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .hero__description :global(a:hover) {
    color: var(--color-text);
  }

  /* ═══════════════════════════════════════════════════════════════
     CTA BUTTONS
     ═══════════════════════════════════════════════════════════════ */
  .hero__ctas {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 2rem; /* Increased from 1.5rem to match original */
    margin-bottom: 2rem;
  }

  /* Primary CTA - Orange button with icon pill */
  .hero__cta-primary {
    display: inline-flex;
    align-items: center;
    position: relative;
    background-color: var(--color-orange, #ff6b30);
    color: white;
    padding: 0.875rem 1.75rem;
    padding-right: 4rem;
    border-radius: 3rem;
    font-weight: 500;
    font-size: 0.9375rem;
    text-decoration: none;
    border: 1px solid hsla(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    box-shadow:
      0 0 15px hsla(17, 100%, 59%, 0.3),
      8px 8px 40px hsla(17, 100%, 59%, 0.5),
      inset -5px -5px 10px hsla(255, 255, 255, 0.15);
    transition: all 0.3s ease;
    overflow: hidden;
  }

  .hero__cta-primary:hover {
    box-shadow:
      0 0 15px hsla(17, 100%, 59%, 0.5),
      8px 8px 40px hsla(17, 100%, 59%, 0.7),
      inset -5px -5px 10px hsla(17, 100%, 59%, 0.15);
    transform: translateY(-2px);
  }

  .hero__cta-text {
    color: white;
  }

  .hero__cta-icon {
    position: absolute;
    right: 3px;
    top: 3px;
    bottom: 3px;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 50%;
    color: var(--color-orange, #ff6b30);
    transition: all 0.3s ease;
  }

  .hero__cta-icon .material-symbols-outlined {
    font-size: 1.25rem;
  }

  .hero__cta-primary:hover .hero__cta-icon {
    width: calc(100% - 6px);
    border-radius: 3rem;
  }

  /* Secondary CTA - Text link with arrow and glass effect */
  .hero__cta-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--color-text);
    font-size: 0.9375rem;
    font-weight: 500;
    text-decoration: none;
    padding: 0.875rem 1.5rem;
    border-radius: 3rem;
    border: 1px solid hsla(163, 46%, 26%, 0.25);
    backdrop-filter: blur(10px);
    box-shadow:
      0 0 15px hsla(255, 255, 255, 0.3),
      8px 8px 40px hsla(163, 46%, 26%, 0.5);
    transition: all 0.3s ease;
  }

  .hero__cta-secondary .material-symbols-outlined {
    font-size: 1.25rem;
    transition: transform 0.2s ease;
  }

  .hero__cta-secondary:hover {
    color: var(--color-green, #255a4e);
    box-shadow:
      0 0 15px hsla(163, 46%, 26%, 0.5),
      8px 8px 40px hsla(163, 46%, 26%, 0.7);
    transform: translateY(-2px);
  }

  .hero__cta-secondary:hover .material-symbols-outlined {
    transform: translateX(4px);
  }

  /* ═══════════════════════════════════════════════════════════════
     SOCIAL PROOF
     ═══════════════════════════════════════════════════════════════ */
  .hero__social-proof {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .hero__avatars {
    display: flex;
  }

  .hero__avatar {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    border: 2px solid var(--color-bg-beige, #f5f0eb);
    overflow: hidden;
    margin-left: calc(var(--index, 0) * -0.75rem);
    position: relative;
    z-index: calc(3 - var(--index, 0));
  }

  .hero__avatar:first-child {
    margin-left: 0;
  }

  .hero__avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .hero__proof-text {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .hero__proof-label {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text);
  }

  .hero__proof-rating {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .hero__stars {
    display: flex;
    gap: 0;
  }

  .hero__star {
    font-size: 0.875rem;
    color: var(--color-neutral-300);
  }

  .hero__star[data-filled="true"] {
    color: var(--color-orange, #ff6b30);
  }

  /* ═══════════════════════════════════════════════════════════════
     IMAGE
     ═══════════════════════════════════════════════════════════════ */
  .hero__image {
    display: none;
  }

  @media (min-width: 1024px) {
    .hero__image {
      display: block;
    }
  }

  .hero__image img {
    border-radius: var(--radius-xl, 1.5rem);
    box-shadow: var(--shadow-lg);
  }

  /* ═══════════════════════════════════════════════════════════════
     RESPONSIVE
     ═══════════════════════════════════════════════════════════════ */
  @media (max-width: 640px) {
    .hero {
      padding-block: calc(var(--header-height, 6.5rem) + 1.5rem) 3rem;
      min-height: auto;
    }

    .hero__headline {
      font-size: 2rem;
    }

    .hero__ctas {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .hero__social-proof {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }
  }
</style>

<script>
  // Add 'is-visible' class when hero enters viewport for highlight animation
  const heroes = document.querySelectorAll('.hero');

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
        }
      });
    },
    { threshold: 0.2 }
  );

  heroes.forEach((hero) => observer.observe(hero));
</script>
