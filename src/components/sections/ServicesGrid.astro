---
import type { ServicesGridSection, Theme } from '../../schemas/sections';
import { parseInlineMarkdown } from '../../utils/markdown';

interface Props {
  data: ServicesGridSection;
  theme?: Theme;
}

const { data, theme } = Astro.props;
const { title, subtitle, services, columns = '4' } = data;

const gridClass = `services-grid--cols-${columns}`;
const parsedTitle = parseInlineMarkdown(title);
const parsedSubtitle = parseInlineMarkdown(subtitle);
---

<section class="services-grid section" data-theme={theme}>
  <div class="container">
    {(parsedTitle || parsedSubtitle) && (
      <div class="services-grid__header">
        {parsedTitle && <h2 class="services-grid__title" set:html={parsedTitle} />}
        {parsedSubtitle && <p class="services-grid__subtitle" set:html={parsedSubtitle} />}
      </div>
    )}

    <div class={`services-grid__grid ${gridClass}`}>
      {services.map((service) => (
        <div class="services-grid__item">
          <h3 class="services-grid__item-title" set:html={parseInlineMarkdown(service.title)} />
          <div class="services-grid__description" set:html={parseInlineMarkdown(service.description)} />
          {service.cta && (
            <a
              href={service.cta.href}
              class="services-grid__link"
              target={service.cta.external ? '_blank' : undefined}
              rel={service.cta.external ? 'noopener noreferrer' : undefined}
            >
              {service.cta.label}
              <svg
                class="services-grid__link-arrow"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
          )}
        </div>
      ))}
    </div>
  </div>
</section>

<style>
  .services-grid {
    background-color: var(--theme-bg, var(--color-bg-beige));
    color: var(--theme-text, var(--color-text));
    padding-block: var(--section-spacing-md);
  }

  .services-grid__header {
    text-align: center;
    max-width: 800px;
    margin-inline: auto;
    margin-bottom: var(--space-16);
  }

  .services-grid__title {
    font-family: var(--font-heading);
    font-size: var(--text-4xl);
    font-weight: var(--font-normal);
    line-height: var(--leading-tight);
    margin-bottom: var(--space-6);
    color: var(--theme-heading, var(--color-text));
  }

  /* Support for highlighted text in title */
  .services-grid__title :global(strong),
  .services-grid__title :global(em),
  .services-grid__title :global(mark) {
    background: linear-gradient(
      to bottom,
      transparent 50%,
      var(--color-accent) 50%,
      var(--color-accent) 85%,
      transparent 85%
    );
    color: inherit;
    font-style: normal;
    font-weight: inherit;
  }

  .services-grid__subtitle {
    font-size: var(--text-base);
    color: var(--theme-text-muted, var(--color-text-muted));
    line-height: var(--leading-relaxed);
    max-width: 700px;
    margin-inline: auto;
  }

  .services-grid__grid {
    display: grid;
    gap: var(--space-8);
  }

  /* Mobile: 1 column */
  @media (max-width: 639px) {
    .services-grid__grid {
      grid-template-columns: 1fr;
      gap: var(--space-10);
    }
  }

  /* Tablet: 2 columns */
  @media (min-width: 640px) {
    .services-grid__grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-8) var(--space-10);
    }
  }

  /* Desktop: 4 columns (or as specified) */
  @media (min-width: 1024px) {
    .services-grid__grid {
      gap: var(--space-8) var(--space-12);
    }

    .services-grid--cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .services-grid--cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .services-grid--cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .services-grid__item {
    display: flex;
    flex-direction: column;
    /* Glass morphism card - matching .cardsBackgroundAndBorder mixin */
    background-color: hsla(0, 0%, 100%, 0.75);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px; /* Double default, matching original */
    padding: var(--space-6);
    border: 1px solid hsla(0, 0%, 100%, 0.3);
    /* Glass shadows */
    box-shadow:
      inset 5px 0 20px 0 hsla(0, 0%, 100%, 0.5),
      inset 0 -30px 30px 0 hsla(0, 0%, 100%, 0.3);
    transition: all 0.5s ease-in-out;
  }

  .services-grid__item:hover {
    transform: translateY(-4px);
    /* Increase opacity on hover (x1.75) */
    background-color: hsla(0, 0%, 100%, 0.9);
    box-shadow:
      0 12px 40px -8px hsla(0, 0%, 0%, 0.12),
      0 8px 20px -6px hsla(17, 100%, 59%, 0.1),
      inset 0 0 20px 0 hsla(0, 0%, 100%, 0.75),
      inset 10px -30px 20px 0 hsla(0, 0%, 100%, 0.5);
  }

  .services-grid__item-title {
    font-family: var(--font-sans);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    line-height: var(--leading-snug);
    margin-bottom: var(--space-4);
    color: var(--theme-heading, var(--color-text));
    padding-bottom: var(--space-3);
    border-bottom: 1px solid hsla(var(--color-grey-hsl), 0.15);
  }

  .services-grid__description {
    flex: 1;
    margin-bottom: var(--space-4);
  }

  /* Description list styling with checkmarks */
  .services-grid__description :global(ul) {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .services-grid__description :global(li) {
    position: relative;
    padding-left: 1.75rem;
    margin-bottom: var(--space-3);
    font-size: var(--text-sm);
    line-height: var(--leading-relaxed);
    color: var(--theme-text-muted, var(--color-text-muted));
  }

  .services-grid__description :global(li)::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0.35em;
    width: 1rem;
    height: 1rem;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6b30' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
  }

  /* Paragraph styling in description */
  .services-grid__description :global(p) {
    font-size: var(--text-sm);
    line-height: var(--leading-relaxed);
    color: var(--theme-text-muted, var(--color-text-muted));
    margin-bottom: var(--space-3);
  }

  .services-grid__description :global(p:last-child) {
    margin-bottom: 0;
  }

  .services-grid__link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-accent);
    text-decoration: none;
    transition: color var(--transition-fast), gap var(--transition-fast);
    margin-top: auto;
    padding-top: var(--space-2);
  }

  .services-grid__link:hover {
    color: var(--color-accent-600);
    gap: var(--space-3);
  }

  .services-grid__link-arrow {
    width: 1.125rem;
    height: 1.125rem;
    transition: transform var(--transition-fast);
    flex-shrink: 0;
  }

  .services-grid__link:hover .services-grid__link-arrow {
    transform: translateX(4px);
  }

  /* Theme variations */
  [data-theme="dark"] .services-grid,
  [data-theme="dark-bold"] .services-grid {
    background-color: var(--color-primary);
    color: var(--color-text-inverted);
  }

  [data-theme="dark"] .services-grid__title,
  [data-theme="dark-bold"] .services-grid__title,
  [data-theme="dark"] .services-grid__item-title,
  [data-theme="dark-bold"] .services-grid__item-title {
    color: var(--color-text-inverted);
  }

  [data-theme="dark"] .services-grid__subtitle,
  [data-theme="dark-bold"] .services-grid__subtitle,
  [data-theme="dark"] .services-grid__description :global(li),
  [data-theme="dark-bold"] .services-grid__description :global(li),
  [data-theme="dark"] .services-grid__description :global(p),
  [data-theme="dark-bold"] .services-grid__description :global(p) {
    color: hsla(var(--color-white-hsl), 0.8);
  }

  [data-theme="dark"] .services-grid__item-title,
  [data-theme="dark-bold"] .services-grid__item-title {
    border-bottom-color: hsla(var(--color-white-hsl), 0.2);
  }

  [data-theme="dark"] .services-grid__description :global(li)::before,
  [data-theme="dark-bold"] .services-grid__description :global(li)::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6b30' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
  }

  /* White background variant */
  [data-theme="light"] .services-grid {
    background-color: var(--color-bg-white);
  }
</style>
