---
/**
 * VerticalTimeline - Animated timeline with scroll-based progression
 * Ported from original noevu.ch Squarespace implementation
 *
 * Features:
 * - Animated vertical line that grows on scroll
 * - Horizontal connectors with circle markers
 * - Content blocks fade in as timeline reaches them
 * - Alternating left/right positioning on desktop
 */
import type { ProcessSection, Theme } from '../../schemas/sections';
import { parseInlineMarkdown } from '../../utils/markdown';

interface Props {
  data: ProcessSection;
  theme?: Theme;
}

const { data, theme } = Astro.props;
const { headline, steps, ctas } = data;
const parsedHeadline = headline ? parseInlineMarkdown(headline) : null;
---

<section class="vertical-timeline section" data-theme={theme}>
  <div class="vertical-timeline__container container">
    {parsedHeadline && (
      <h2 class="vertical-timeline__title" set:html={parsedHeadline} />
    )}

    <div class="vertical-timeline__content">
      <!-- The timeline line -->
      <div class="timeline-vertical" data-animation-start-percentage="70">
        <div class="vertical-line-animated"></div>
      </div>

      <!-- Timeline steps -->
      <div class="vertical-timeline__steps">
        {steps.map((step, index) => {
          const isLeft = index % 2 === 0;
          const positionClass = isLeft ? 'timeline-step--left' : 'timeline-step--right';
          const connectorClass = isLeft ? 'horizontal-right' : 'horizontal-left';

          return (
            <div class={`timeline-step ${positionClass}`} data-index={index}>
              <!-- Horizontal connector with circle -->
              <div class={`timeline-connector ${connectorClass}`}></div>

              <!-- Content block -->
              <div class="timeline-step__content">
                {(step.eyebrow || step.subtitle) && (
                  <span class="timeline-step__eyebrow">{step.eyebrow || step.subtitle}</span>
                )}
                <h3 class="timeline-step__title" set:html={parseInlineMarkdown(step.title)} />
                <div class="timeline-step__description" set:html={parseInlineMarkdown(step.description || '')} />

                {step.image && (
                  <div class="timeline-step__image">
                    <img
                      src={step.image.src}
                      alt={step.image.alt}
                      loading="lazy"
                    />
                  </div>
                )}

                {step.cta && (
                  <a href={step.cta.href} class="timeline-step__cta btn btn--accent">
                    {step.cta.label}
                    <span class="material-symbols-outlined">arrow_forward</span>
                  </a>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>

    {ctas && ctas.length > 0 && (
      <div class="vertical-timeline__ctas">
        {ctas.map((cta, index) => (
          <a
            href={cta.href}
            class={`btn ${index === 0 ? 'btn--accent' : 'btn--secondary'}`}
          >
            {cta.label}
          </a>
        ))}
      </div>
    )}
  </div>
</section>

<style>
  /* ═══════════════════════════════════════════════════════════════
     CSS VARIABLES - Timeline configuration
     ═══════════════════════════════════════════════════════════════ */
  .vertical-timeline {
    /* Colors */
    --timeline-color: hsla(var(--color-green-hsl, 163, 41%, 25%), 0.3);
    --timeline-animated-color: var(--color-orange, #ff6b30);
    --timeline-stop-bg: transparent;

    /* Sizes */
    --circle-size: 8px;
    --circle-size-active: 12px;
    --timeline-width: 2px;
    --timeline-animated-width: 3px;
    --horizontal-line-length: 30px;

    /* Transitions */
    --timeline-transition: 0.3s ease-in-out;

    position: relative;
    overflow: hidden;
  }

  .vertical-timeline__container {
    position: relative;
  }

  .vertical-timeline__title {
    text-align: center;
    font-size: var(--text-3xl);
    color: var(--theme-heading, var(--color-text));
    margin-bottom: var(--space-16);
    max-width: 800px;
    margin-inline: auto;
  }

  .vertical-timeline__title :global(strong),
  .vertical-timeline__title :global(em) {
    color: var(--color-orange, #ff6b30);
    font-style: normal;
  }

  /* ═══════════════════════════════════════════════════════════════
     TIMELINE LAYOUT
     ═══════════════════════════════════════════════════════════════ */
  .vertical-timeline__content {
    position: relative;
    max-width: 1100px;
    margin-inline: auto;
  }

  /* The vertical line container */
  .timeline-vertical {
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: var(--timeline-width);
    background: var(--timeline-color);
    transform: translateX(-50%);
    z-index: 1;
  }

  /* Animated growing line */
  .vertical-line-animated {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: var(--timeline-animated-width);
    height: 0;
    background: var(--timeline-animated-color);
    border-radius: var(--timeline-animated-width);
    z-index: 2;
    will-change: height;
    box-shadow: 0 0 10px hsla(17, 100%, 59%, 0.5);
  }

  /* Steps container */
  .vertical-timeline__steps {
    position: relative;
    z-index: 3;
  }

  /* ═══════════════════════════════════════════════════════════════
     TIMELINE STEP
     ═══════════════════════════════════════════════════════════════ */
  .timeline-step {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: var(--space-8);
    margin-bottom: var(--space-16);
    opacity: 0.4;
    transition: opacity var(--timeline-transition);
  }

  .timeline-step:last-child {
    margin-bottom: 0;
  }

  .timeline-step.timeline-stop-activated {
    opacity: 1;
  }

  /* Left-positioned step */
  .timeline-step--left .timeline-step__content {
    grid-column: 1;
    text-align: right;
    padding-right: var(--space-4);
  }

  .timeline-step--left .timeline-connector {
    grid-column: 2;
  }

  .timeline-step--left::after {
    content: '';
    grid-column: 3;
  }

  /* Right-positioned step */
  .timeline-step--right::before {
    content: '';
    grid-column: 1;
  }

  .timeline-step--right .timeline-connector {
    grid-column: 2;
  }

  .timeline-step--right .timeline-step__content {
    grid-column: 3;
    text-align: left;
    padding-left: var(--space-4);
  }

  /* ═══════════════════════════════════════════════════════════════
     HORIZONTAL CONNECTORS
     ═══════════════════════════════════════════════════════════════ */
  .timeline-connector {
    position: relative;
    width: calc(var(--horizontal-line-length) * 2);
    display: flex;
    align-items: flex-start;
    padding-top: 0.5rem;
  }

  /* Horizontal line */
  .timeline-connector::before {
    content: '';
    position: absolute;
    top: 0.75rem;
    height: var(--timeline-width);
    background: var(--timeline-color);
    transition: background var(--timeline-transition), height var(--timeline-transition);
  }

  .horizontal-right::before {
    left: 50%;
    right: 0;
  }

  .horizontal-left::before {
    left: 0;
    right: 50%;
  }

  /* Circle marker */
  .timeline-connector::after {
    content: '';
    position: absolute;
    top: calc(0.75rem - var(--circle-size) / 2);
    width: var(--circle-size);
    height: var(--circle-size);
    border: var(--timeline-width) solid var(--timeline-color);
    background: var(--timeline-stop-bg, var(--theme-bg, white));
    border-radius: 50%;
    transition: all var(--timeline-transition);
  }

  .horizontal-right::after {
    right: calc(var(--circle-size) / -2);
  }

  .horizontal-left::after {
    left: calc(var(--circle-size) / -2);
  }

  /* Activated state */
  .timeline-step.timeline-stop-activated .timeline-connector::before {
    background: var(--timeline-animated-color);
    height: var(--timeline-animated-width);
  }

  .timeline-step.timeline-stop-activated .timeline-connector::after {
    --circle-size: var(--circle-size-active);
    border-color: var(--timeline-animated-color);
    box-shadow: 0 0 8px hsla(17, 100%, 59%, 0.6);
  }

  /* ═══════════════════════════════════════════════════════════════
     STEP CONTENT
     ═══════════════════════════════════════════════════════════════ */
  .timeline-step__content {
    max-width: 450px;
  }

  .timeline-step--left .timeline-step__content {
    margin-left: auto;
  }

  .timeline-step__eyebrow {
    display: inline-block;
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-orange, #ff6b30);
    margin-bottom: var(--space-2);
  }

  .timeline-step__title {
    font-family: var(--font-sans);
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--theme-heading, var(--color-text));
    margin-bottom: var(--space-3);
    line-height: 1.3;
  }

  .timeline-step__title :global(strong),
  .timeline-step__title :global(em) {
    color: var(--color-orange, #ff6b30);
    font-style: normal;
    font-weight: inherit;
  }

  .timeline-step__description {
    font-size: var(--text-base);
    color: var(--theme-text-muted, var(--color-text-muted));
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-4);
  }

  .timeline-step__description :global(strong) {
    color: var(--theme-text, var(--color-text));
    font-weight: var(--font-semibold);
  }

  .timeline-step__image {
    margin-top: var(--space-4);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .timeline-step__image img {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s ease;
  }

  .timeline-step.timeline-stop-activated .timeline-step__image img {
    transform: scale(1.02);
  }

  .timeline-step__cta {
    margin-top: var(--space-4);
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }

  .timeline-step__cta .material-symbols-outlined {
    font-size: 1.25rem;
    transition: transform 0.2s ease;
  }

  .timeline-step__cta:hover .material-symbols-outlined {
    transform: translateX(4px);
  }

  /* ═══════════════════════════════════════════════════════════════
     BOTTOM CTA
     ═══════════════════════════════════════════════════════════════ */
  .vertical-timeline__ctas {
    display: flex;
    justify-content: center;
    gap: var(--space-4);
    margin-top: var(--space-16);
    flex-wrap: wrap;
  }

  /* ═══════════════════════════════════════════════════════════════
     MOBILE LAYOUT
     ═══════════════════════════════════════════════════════════════ */
  @media (max-width: 768px) {
    .timeline-vertical {
      left: 1rem;
      transform: none;
    }

    .timeline-step {
      display: block;
      padding-left: calc(1rem + var(--horizontal-line-length) + var(--space-4));
      position: relative;
    }

    .timeline-step--left .timeline-step__content,
    .timeline-step--right .timeline-step__content {
      text-align: left;
      padding: 0;
      margin: 0;
      max-width: none;
    }

    .timeline-connector {
      position: absolute;
      left: 1rem;
      top: 0;
      width: var(--horizontal-line-length);
    }

    .horizontal-left::before,
    .horizontal-right::before {
      left: 0;
      right: auto;
      width: var(--horizontal-line-length);
    }

    .horizontal-left::after,
    .horizontal-right::after {
      left: auto;
      right: calc(var(--circle-size) / -2);
    }

    .timeline-step::before,
    .timeline-step::after {
      display: none;
    }
  }

  /* ═══════════════════════════════════════════════════════════════
     DARK THEME
     ═══════════════════════════════════════════════════════════════ */
  [data-theme="dark"] .vertical-timeline,
  [data-theme="dark-bold"] .vertical-timeline,
  [data-theme="black"] .vertical-timeline,
  [data-theme="black-bold"] .vertical-timeline {
    --timeline-color: hsla(var(--color-white-hsl), 0.2);
    --timeline-stop-bg: var(--theme-bg, #141110);
  }

  [data-theme="dark"] .timeline-connector::after,
  [data-theme="dark-bold"] .timeline-connector::after,
  [data-theme="black"] .timeline-connector::after,
  [data-theme="black-bold"] .timeline-connector::after {
    background: var(--theme-bg, #141110);
  }
</style>

<script>
  /**
   * Timeline scroll animation - ported from original noevu.ch
   */

  const DEFAULT_ANIMATION_START = 70; // percentage of viewport height

  let viewportHeight = window.innerHeight;

  function updateViewport() {
    viewportHeight = window.innerHeight;
  }

  function parseStartPercentage(el: Element): number {
    const raw = (el as HTMLElement).dataset.animationStartPercentage;
    const n = parseInt(raw || '', 10);
    if (!isNaN(n) && n >= 1 && n <= 100) return n;
    return DEFAULT_ANIMATION_START;
  }

  function updateTimelineLine(timeline: Element) {
    const animatedLine = timeline.querySelector('.vertical-line-animated') as HTMLElement;
    if (!animatedLine) return;

    const startPercent = parseStartPercentage(timeline);
    const thresholdPx = viewportHeight * (startPercent / 100);

    const lineRect = animatedLine.getBoundingClientRect();
    const timelineRect = timeline.getBoundingClientRect();
    const lineTop = timelineRect.top;
    const timelineBottom = timelineRect.bottom;

    if (lineTop < thresholdPx && timelineBottom > thresholdPx) {
      animatedLine.style.height = `${thresholdPx - lineTop}px`;
    } else if (timelineBottom <= thresholdPx) {
      animatedLine.style.height = `${timelineBottom - lineTop}px`;
    } else {
      animatedLine.style.height = '0px';
    }
  }

  function checkStops() {
    document.querySelectorAll('.vertical-timeline').forEach((section) => {
      const timeline = section.querySelector('.timeline-vertical');
      if (!timeline) return;

      const startPercent = parseStartPercentage(timeline);
      const thresholdPx = viewportHeight * (startPercent / 100);

      section.querySelectorAll('.timeline-step').forEach((step) => {
        const connector = step.querySelector('.timeline-connector');
        if (!connector) return;

        const rect = connector.getBoundingClientRect();
        const pos = rect.top + 20;

        step.classList.toggle('timeline-stop-activated', pos < thresholdPx);
      });
    });
  }

  function initTimeline() {
    updateViewport();

    // Initial update
    document.querySelectorAll('.timeline-vertical').forEach(updateTimelineLine);
    checkStops();

    // Scroll handler
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          document.querySelectorAll('.timeline-vertical').forEach(updateTimelineLine);
          checkStops();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Resize handler
    window.addEventListener('resize', () => {
      updateViewport();
      document.querySelectorAll('.timeline-vertical').forEach(updateTimelineLine);
      checkStops();
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTimeline);
  } else {
    initTimeline();
  }
</script>
