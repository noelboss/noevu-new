---
/**
 * Blog listing page
 *
 * Displays all blog posts in a grid layout with filtering by category.
 * Content comes from MDX files in src/content/blog/
 */
import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import Newsletter from '../../components/sections/Newsletter.astro';

import navigationData from '../../content/navigation.json';
import siteData from '../../content/site.json';

/**
 * Calculate reading time from text content
 * Average reading speed: 200 words per minute (German text)
 */
function calculateReadingTime(text: string): number {
  const wordsPerMinute = 200;
  const words = text.trim().split(/\s+/).length;
  const minutes = Math.ceil(words / wordsPerMinute);
  return Math.max(1, minutes);
}

// Get blog posts from content collection
const blogEntries = await getCollection('blog');
const posts = blogEntries
  .map(entry => ({
    title: entry.data.title,
    slug: entry.data.slug || entry.id.replace(/\.md$/, ''),
    excerpt: entry.data.excerpt,
    featuredImage: entry.data.featuredImage,
    categories: entry.data.categories || [],
    publishedAt: entry.data.publishedAt,
    author: entry.data.author,
    readingTime: entry.data.readingTime || calculateReadingTime(entry.body || ''),
  }))
  .sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());

// Get unique categories from all posts
const allCategories = [...new Set(posts.flatMap(post => post.categories || []))];
---

<Base
  title="Blog | Noevu"
  description="Tipps, Insights und News rund um Webdesign, Squarespace und AI für Schweizer KMU."
>
  <Header navigation={navigationData as any} currentPath="/blog" />

  <main id="main-content">
    <section class="blog-hero section">
      <div class="container">
        <h1 class="blog-hero__title">Blog</h1>
        <p class="blog-hero__subtitle">
          Tipps, digitale Insights und strategische Geschichten aus dem Schweizer Vorsprung.
        </p>
      </div>
    </section>

    {allCategories.length > 0 && (
      <section class="blog-filters section--sm">
        <div class="container">
          <div class="blog-filters__list">
            <a href="/blog" class="blog-filters__item blog-filters__item--active">
              Alle
            </a>
            {allCategories.map((category) => (
              <a
                href={`/blog/category/${encodeURIComponent(category.toLowerCase())}`}
                class="blog-filters__item"
              >
                {category}
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <section class="blog-list section">
      <div class="container">
        {posts.length > 0 ? (
          <div class="blog-list__grid">
            {posts.map((post) => (
              <BlogCard
                title={post.title}
                slug={post.slug}
                excerpt={post.excerpt}
                featuredImage={post.featuredImage}
                categories={post.categories}
                publishedAt={post.publishedAt}
                author={post.author}
                readingTime={post.readingTime}
              />
            ))}
          </div>
        ) : (
          <div class="blog-list__empty">
            <p>Noch keine Blog-Beiträge vorhanden.</p>
            <p class="text-muted">Schauen Sie bald wieder vorbei!</p>
          </div>
        )}
      </div>
    </section>

    <Newsletter data={{
      type: 'newsletter',
      title: 'Insights für euren digitalen Vorsprung',
      description: 'Erhaltet regelmässig Tipps, News und Strategien rund um Webdesign, AI und digitales Marketing – direkt in euren Posteingang.',
      buttonText: 'Jetzt anmelden',
      placeholderText: 'Eure E-Mail-Adresse',
      privacyText: 'Wir respektieren eure Privatsphäre. Abmeldung jederzeit möglich.',
      backgroundColor: 'green',
    }} />
  </main>

  <Footer navigation={navigationData as any} site={siteData as any} />
</Base>

<style>
  .blog-hero {
    background-color: var(--color-bg-beige);
    text-align: center;
  }

  .blog-hero__title {
    font-size: var(--text-5xl);
    margin-bottom: var(--space-4);
  }

  .blog-hero__subtitle {
    font-size: var(--text-xl);
    color: var(--color-text-muted);
    max-width: 600px;
    margin-inline: auto;
  }

  .blog-filters {
    background-color: var(--color-bg-beige);
    border-bottom: 1px solid var(--color-neutral-200);
  }

  .blog-filters__list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    justify-content: center;
  }

  .blog-filters__item {
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-text-muted);
    background-color: transparent;
    border-radius: var(--radius-full);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .blog-filters__item:hover {
    background-color: var(--color-bg-white);
    color: var(--color-text);
  }

  .blog-filters__item--active {
    background-color: var(--color-primary);
    color: var(--color-text-inverted);
  }

  .blog-list {
    background-color: var(--color-bg-beige);
  }

  .blog-list__grid {
    display: grid;
    gap: var(--space-8);
  }

  @media (min-width: 640px) {
    .blog-list__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .blog-list__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .blog-list__empty {
    text-align: center;
    padding: var(--space-16);
  }

  .blog-list__empty p {
    font-size: var(--text-lg);
    margin-bottom: var(--space-2);
  }
</style>
